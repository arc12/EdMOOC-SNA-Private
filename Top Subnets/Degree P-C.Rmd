```{r echo=FALSE, results='hide', message=FALSE}
if(!exists("courseID", inherits=T)){
   #specify a single course here. Ignored when called (iteratively) from "Degree P-C - All Courses.R"
    courseID<-"crit"#c("aiplan","astro","crit","edc","equine","intro")
}
net.type="P-C" #poster-commenter filename prefix
store.dir<-"~/R Projects/Edinburgh MOOC/EdMOOC-SNA/Network Data/" #where the extracted networks are stored
echo.flag<-TRUE #echo R source
fig.width.default<-5
fig.height.default<-5
options(knitr.table.format = 'markdown')
library("sna")
library("network")
```

Extract and Visualise the Sub-network Containing the Highest In- and Out-degree Individuals - `r courseID`
========================================================

This treats "Poster-Commenter" networks. The assumption of the following that a tie between individuals is defined by a comment on a post. This is a directed tie from the commenter to the poster. A tie is assumed if there are 1 or more comments and ties are **not** weighted by the number of comments.


```{r  echo=FALSE}
#loads RData file containiing network object and metadata
load(paste(store.dir,net.type," ",courseID,".RData", sep=""))
cat(paste("Loaded data. Created by:",metadata$origin,"Created on:",metadata$created))
print(net1)
```

## Preliminaries - identify the highest in/out degree individuals

```{r  echo=echo.flag}
odeg<-degree(net1, cmode="outdegree")
ideg<-degree(net1, cmode="indegree")
#get indexes to nodes and filter for tiny quantile (0.5%)
ocentile<-quantile(odeg,0.995)
icentile<-quantile(ideg,0.995)
oindex<-which(odeg>=ocentile)
iindex<-which(ideg>=icentile)
odeg<-odeg[oindex]
ideg<-ideg[iindex]
#order
oorder<-order(odeg, decreasing=T)
iorder<-order(ideg, decreasing=T)
odeg<-odeg[oorder]
ideg<-ideg[iorder]
oindex<-oindex[oorder]
iindex<-iindex[iorder]
# combine forum_user_id and role from nodes with degree.
vroles<-net1 %v% "role"
vnames<-net1 %v% "vertex.names"
outdegree.df<-cbind(forum_user_id=vnames[oindex], role=vroles[oindex], out.degree=odeg, match.in=oindex %in% iindex)
indegree.df<-cbind(forum_user_id=vnames[iindex], role=vroles[iindex], in.degree=ideg, match.out=iindex %in% oindex)
```

**People with highest 0.5% Quantile Out-degree**

```{r results='asis', echo=FALSE}
kable(outdegree.df)
```

**People with Highest 0.5% Quantile In-degree**

```{r results='asis', echo=FALSE}
kable(indegree.df)
```
_Match.in/out shows where the same person appears in the other list._

## Extract the Subnet
```{r fig.width=10, fig.height=10}
# obtain the subgraph containing these nodes and linked edges
top.subnet<-net1 %s% c(get.neighborhood(net1,iindex, type="combined"), get.neighborhood(net1,iindex, type="combined"))
vertex.col<-as.numeric(top.subnet %v% "role")
plot(top.subnet, arrowhead.cex=0.7, edge.lwd=0.4, vertex.col=vertex.col, vertices.last=FALSE)
```
```{r fig.width=4, fig.height=5, echo=F}
plot.new()
leg=c("Administrator","Instructor","Teaching Staff","Student","Blocked","Student Access","Community TA","School Administrator","Student (Forum Banned)")
legend(x=0,y=1,title="Roles", legend=leg, seq(1,9))
```
In practice, choosing a lower quantile (more high degree people selected) does not make much difference to the subnet if there are 1 or 2 very high degree individuals.

```{r echo=FALSE}
#save in UCINET DL format for gephi. This is limited to a single vertex label AFAIK.
# There are self-loops in exported data, so I assume loops=FALSE network attribute controls processing, not the data structure
fname<-paste("~/R Projects/Edinburgh MOOC/EdMOOC-SNA/Top Subnets/Degree ", net.type, " - " ,courseID,".dl",sep="")
write.dl(top.subnet, fname, vertex.lab=top.subnet %v% "role")
cat(paste("Saved UCINET DL file to:", fname))
```


```{r echo=FALSE}
## ****************************************************
## Created: Adam Cooper, Cetis, Oct 2013
## This source code was produced for The University of
## Edinburgh DEI as part of their MOOC initiative.
## ****************************************************

## ***Made available using the The MIT License (MIT)***
#The MIT License (MIT)
#Copyright (c) 2013 Adam Cooper, University of Bolton
#
#Permission is hereby granted, free of charge, to any person obtaining a copy of
#this software and associated documentation files (the "Software"), to deal in
# the Software without restriction, including without limitation the rights to
# use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
# the Software, and to permit persons to whom the Software is furnished to do so,
# subject to the following conditions:
#    
#    The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
# FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
# IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
# CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
## ************ end licence ***************
```